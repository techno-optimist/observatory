# Observatory - Docker Compose
#
# Local development setup that mirrors production architecture.
#
# Usage:
#   docker compose up              # Start both services
#   docker compose up -d           # Start in background
#   docker compose logs -f         # Follow logs
#   docker compose down            # Stop services
#   docker compose down -v         # Stop and remove volumes
#
# Architecture:
#   observatory-backend (FastAPI + ML) <-- observatory-mcp (SSE) <-- Claude clients

services:
  # ===========================================================================
  # Observatory Backend (FastAPI + ML)
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: observatory-backend
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - HOST=0.0.0.0
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
      # Uncomment to enable Anthropic API features
      # - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      # Persistent storage for projections, cache, and annotations
      - observatory-data:/app/data
      # Mount source for development (optional - comment out for production-like testing)
      # - ./backend:/app:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # ML models take time to load
    restart: unless-stopped

  # ===========================================================================
  # Observatory MCP Server (SSE Transport)
  # ===========================================================================
  mcp-server:
    build:
      context: ./mcp-server
      dockerfile: Dockerfile
    container_name: observatory-mcp
    ports:
      - "8080:8080"
    environment:
      - OBSERVATORY_BACKEND_URL=http://backend:8000
      - OBSERVATORY_DEFAULT_MODEL=all-MiniLM-L6-v2
      - PORT=8080
      - HOST=0.0.0.0
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  observatory-data:
    name: observatory-data
    # Data persists across container restarts
    # Contains: projections/, annotations/, embedding_cache.db, experiments.db

# ===========================================================================
# Networks (optional - uses default bridge)
# ===========================================================================
# networks:
#   observatory-net:
#     driver: bridge
